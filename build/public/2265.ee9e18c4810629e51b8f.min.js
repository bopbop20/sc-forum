"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[2265],{35127:(Q,V,l)=>{var M,L;M=[l(27145),l(32230),l(22143),l(45482),l(47913),l(88186),l(98755),l(83713),l(38259),l(2585),l(98166),l(75203),l(62023),l(74344),l(31369),l(7927),l(85233),l(44882),l(7073),l(10577)],L=function(x,w,j,h,c,P,R,r,s,n,d,u,I,b,A,D,a,m,p,g){var i={active:void 0,posts:{},bsEnvironment:void 0,formatting:void 0};$(window).off("resize",K).on("resize",K),K(),$(window).on("action:composer.topics.post",function(e,t){localStorage.removeItem("category:"+t.data.cid+":bookmark"),localStorage.removeItem("category:"+t.data.cid+":bookmark:clicked")}),$(window).on("popstate",function(){var e=utils.findBootstrapEnvironment();if(i.active&&(e==="xs"||e==="sm")){if(!i.posts[i.active].modified){i.discard(i.active),i.discardConfirm&&i.discardConfirm.length&&(i.discardConfirm.modal("hide"),delete i.discardConfirm);return}w.translate("[[modules:composer.discard]]",function(t){i.discardConfirm=A.confirm(t,function(o){o?i.discard(i.active):i.posts[i.active].modified=!0}),i.posts[i.active].modified=!1})}});function C(){var e=i.bsEnvironment;(ajaxify.data.template.compose===!0||e==="xs"||e==="sm")&&history.back()}function K(){var e=utils.findBootstrapEnvironment(),t=e==="xs"||e==="sm";r.toggle&&(r.env!==e&&t&&(r.env=e,r.toggle(!1)),r.env=e),i.active!==void 0&&(s.reposition($('.composer[data-uuid="'+i.active+'"]')),!t&&window.location.pathname.startsWith(config.relative_path+"/compose")?history.back():t&&!window.location.pathname.startsWith(config.relative_path+"/compose")&&Z()),i.bsEnvironment=e}function ie(e){var t,o;e.hasOwnProperty("cid")?t="cid":e.hasOwnProperty("tid")?t="tid":e.hasOwnProperty("pid")&&(t="pid"),o=e[t];for(var f in i.posts)if(i.posts[f].hasOwnProperty(t)&&o===i.posts[f][t])return f;return!1}function X(e){var t=utils.generateUUID(),o=ie(e);if(o)return x.updateActive(o),i.load(o);var f="[[topic:composer.new_topic]]";e.action==="posts.reply"?f="[[topic:composer.replying_to]]":e.action==="posts.edit"&&(f="[[topic:composer.editing]]"),w.translate(f,function(v){x.push("composer",t,{title:v.replace("%1",'"'+e.title+'"')})}),e.hasOwnProperty("cid")?e.save_id=["composer",app.user.uid,"cid",e.cid].join(":"):e.hasOwnProperty("tid")?e.save_id=["composer",app.user.uid,"tid",e.tid].join(":"):e.hasOwnProperty("pid")&&(e.save_id=["composer",app.user.uid,"pid",e.pid].join(":")),i.posts[t]=e,i.load(t)}async function E(e,t){$('.composer[data-uuid="'+e+'"]').find(".composer-submit").removeAttr("disabled");const{showAlert:o}=await a.fire("filter:composer.error",{post_uuid:e,message:t,showAlert:!0});o&&D.alert({type:"danger",timeout:1e4,title:"",message:t,alert_id:"post_error"})}i.findByTid=function(e){for(var t in i.posts)if(i.posts.hasOwnProperty(t)&&i.posts[t].hasOwnProperty("tid")&&parseInt(i.posts[t].tid,10)===parseInt(e,10))return t;return null},i.addButton=function(e,t,o){h.addButton(e,t,o)},i.newTopic=async e=>{var t={action:"topics.post",cid:e.cid,handle:e.handle,title:e.title||"",body:e.body||"",tags:e.tags||[],modified:!!(e.title&&e.title.length||e.body&&e.body.length),isMain:!0};({pushData:t}=await a.fire("filter:composer.topic.push",{data:e,pushData:t})),X(t)},i.addQuote=function(e,t,o,f,v,T,y){y=y||i.active;var H=(f||"").replace(/([\\`*_{}[\]()#+\-.!])/g,"\\$1").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;").replace(/%/g,"&#37;").replace(/,/g,"&#44;");T&&(T="> "+T.replace(/\n/g,`
> `)+`

`);var J="["+H+"]("+config.relative_path+"/post/"+(o||t)+")";if(y===void 0){f&&(o||t)?i.newReply(e,t,f,"[[modules:composer.user_said_in, "+v+", "+J+`]]
`+T):i.newReply(e,t,f,"[[modules:composer.user_said, "+v+`]]
`+T);return}else y!==i.active&&i.load(y);var S=$('.composer[data-uuid="'+y+'"]'),W=S.find("textarea"),B=W.val();f&&(o||t)?w.translate("[[modules:composer.user_said_in, "+v+", "+J+`]]
`,config.defaultLang,F):w.translate("[[modules:composer.user_said, "+v+`]]
`,config.defaultLang,F);function F(U){i.posts[y].body=(B.length?B+`

`:"")+U+T,W.val(i.posts[y].body),G(S),r.render(S)}},i.newReply=function(e,t,o,f){w.translate(f,config.defaultLang,function(v){X({action:"posts.reply",tid:e,toPid:t,title:o,body:v,modified:!!(o&&o.length||v&&v.length),isMain:!1})})},i.editPost=function(e){socket.emit("plugins.composer.push",e,function(t,o){if(t)return D.error(t);o.action="posts.edit",o.pid=e,o.modified=!1,X(o)})},i.load=function(e){var t=$('.composer[data-uuid="'+e+'"]');t.length?(O(e),s.reposition(t),G(t),q()):i.formatting?k(e):socket.emit("plugins.composer.getFormattingOptions",function(o,f){if(o)return D.error(o);i.formatting=f,k(e)})},i.enhance=function(e,t,o){!t&&!o&&(t=utils.generateUUID(),i.posts[t]=ajaxify.data,o=ajaxify.data,e.attr("data-uuid",t));var f=e.find("textarea"),v=e.find(".composer-submit");R.init(e,i.posts[t]),d.init(e,i.posts),h.addHandler(e),h.addComposerButtons(),r.handleToggler(e),j.initialize(t),P.init(e,i.posts[t]),n.init(e,t),e.on("change","input, textarea",function(){i.posts[t].modified=!0,c.updateVisibility("available",i.posts[t].save_id,!0),c.updateVisibility("open",i.posts[t].save_id,!0)}),v.on("click",function(y){y.preventDefault(),y.stopPropagation(),$(this).attr("disabled",!0),ee(t)}),l.e(2441).then(function(){var y=[l(42441)];(function(H){H(e.get(0)).bind("mod+enter",function(){v.attr("disabled",!0),ee(t)})}).apply(null,y)}).catch(l.oe),e.find(".composer-discard").on("click",function(y){if(y.preventDefault(),!i.posts[t].modified)return i.discard(t),C();h.exitFullscreen();var H=$(this).prop("disabled",!0);w.translate("[[modules:composer.discard]]",function(J){A.confirm(J,function(S){S&&(i.discard(t),C()),H.prop("disabled",!1)})})}),e.find(".composer-minimize, .minimize .trigger").on("click",function(y){y.preventDefault(),y.stopPropagation(),i.minimize(t)}),f.on("input propertychange",utils.debounce(function(){r.render(e)},250)),f.on("scroll",function(){r.matchScroll(e)}),c.init(e,o);const T=c.get(o.save_id);r.render(e,function(){r.matchScroll(e)}),z(e),N(e),G(e),o.action==="posts.edit"&&i.updateThumbCount(t,e),g.isEnabled||$('[data-format="zen"]').addClass("hidden"),a.fire("action:composer.enhanced",{postContainer:e,postData:o,draft:T})};async function _(e){return ajaxify.data.template.category?ajaxify.data:parseInt(e.cid,10)?await b.get(`/api/category/${e.cid}`,{}):null}async function k(e){var t=i.posts[e],o=t?t.hasOwnProperty("cid"):!1,f=t?!!t.isMain:!1,v=t?!!t.pid:!1,T=t?parseInt(t.uid,10)===0:!1;const y=t.timestamp>Date.now();var H=t.title.replace(/%/g,"&#37;").replace(/,/g,"&#44;");t.category=await _(t);const J=t.category?t.category.privileges:ajaxify.data.privileges;var S={title:H,titleLength:H.length,body:t.body,mobile:i.bsEnvironment==="xs"||i.bsEnvironment==="sm",resizable:!0,thumb:t.thumb,isTopicOrMain:o||f,maximumTitleLength:config.maximumTitleLength,maximumPostLength:config.maximumPostLength,minimumTagLength:config.minimumTagLength,maximumTagLength:config.maximumTagLength,isTopic:o,isEditing:v,canSchedule:!!(f&&J&&(J["topics:schedule"]&&!v||y&&J.view_scheduled)),showHandleInput:config.allowGuestHandles&&(app.user.uid===0||v&&T&&app.user.isAdmin),handle:t?t.handle||"":void 0,formatting:i.formatting,tagWhitelist:t.category?t.category.tagWhitelist:ajaxify.data.tagWhitelist,privileges:app.user.privileges,selectedCategory:t.category,submitOptions:[]};S.mobile&&(Z(),app.toggleNavbar(!1)),t.mobile=i.bsEnvironment==="xs"||i.bsEnvironment==="sm",{postData:t,createData:S}=await a.fire("filter:composer.create",{postData:t,createData:S}),app.parseAndTranslate("composer",S,function(W){if(!$('.composer.composer[data-uuid="'+e+'"]').length){W=$(W),W.find(".title").each(function(){$(this).text(w.unescape($(this).text()))}),W.attr("data-uuid",e),$(document.body).append(W);var B=$(W[0]);if(s.reposition(B),i.enhance(B,e,t),O(e),B.on("click",function(){x.isActive(e)||x.updateActive(e)}),s.handleResize(B),i.bsEnvironment==="xs"||i.bsEnvironment==="sm"){var F=B.find(".composer-submit"),U=B.find(".mobile-navbar .composer-submit"),ne=B.find(".write"),te=ne.attr("tabindex");F.removeAttr("tabindex"),U.attr("tabindex",parseInt(te,10)+1),$(".category-name-container").on("click",function(){$(".category-selector").toggleClass("open")})}$(window).trigger("action:composer.loaded",{postContainer:B,post_uuid:e,composerData:i.posts[e],formatting:i.formatting}),u.apply(B.find(".write")),G(B),q()}})}function Z(){var e="compose?p="+window.location.pathname,t=window.location.pathname.slice(1)+window.location.search;t.startsWith(config.relative_path.slice(1))&&(t=t.slice(config.relative_path.length)),window.history.replaceState({url:null,returnPath:t},t,config.relative_path+"/"+t),window.history.pushState({url:e},e,`${config.relative_path}/${t}`)}function z(e){var t=e.find(".help");socket.emit("plugins.composer.renderHelp",function(o,f){!o&&f&&f.length>0&&(t.removeClass("hidden"),t.on("click",function(){A.alert(f)}))})}function N(e){var t=e.attr("data-uuid"),o=i.posts[t]&&i.posts[t].action==="posts.edit",f=utils.findBootstrapEnvironment(),v=f==="xs"||f==="sm";o||v||p.enableQuickSearch({searchElements:{inputEl:e.find("input.title"),resultEl:e.find(".quick-search-container")},hideOnNoMatches:!0})}function O(e){i.active&&i.active!==e&&i.minimize(i.active),i.active=e,$(window).trigger("action:composer.activate",{post_uuid:e})}function G(e){setTimeout(function(){var t=e.find("input.title");t.length?t.focus():e.find("textarea").focus().putCursorAtEnd()},20)}async function ee(e){var t=i.posts[e],o=$('.composer[data-uuid="'+e+'"]'),f=o.find(".handle"),v=o.find(".title"),T=o.find("textarea"),y=o.find("input#topic-thumb-url"),H=t.hasOwnProperty("template")&&t.template.compose===!0;const J=o.find(".composer-submit");v.val(v.val().trim()),T.val(utils.rtrim(T.val())),y.length&&y.val(y.val().trim());var S=t.action,W=(t.hasOwnProperty("cid")||parseInt(t.pid,10))&&o.find("input.title").length,B=!W||W&&parseInt(t.cid,10),F={post_uuid:e,postData:t,postContainer:o,titleEl:v,titleLen:v.val().length,bodyEl:T,bodyLen:T.val().length};if(await a.fire("filter:composer.check",F),$(window).trigger("action:composer.check",F),F.error)return E(e,F.error);if(j.inProgress[e]&&j.inProgress[e].length)return E(e,"[[error:still-uploading]]");if(W&&F.titleLen<parseInt(config.minimumTitleLength,10))return E(e,"[[error:title-too-short, "+config.minimumTitleLength+"]]");if(W&&F.titleLen>parseInt(config.maximumTitleLength,10))return E(e,"[[error:title-too-long, "+config.maximumTitleLength+"]]");if(S==="topics.post"&&!B)return E(e,"[[error:category-not-selected]]");if(F.bodyLen<parseInt(config.minimumPostLength,10))return E(e,"[[error:content-too-short, "+config.minimumPostLength+"]]");if(F.bodyLen>parseInt(config.maximumPostLength,10))return E(e,"[[error:content-too-long, "+config.maximumPostLength+"]]");if(W&&!P.isEnoughTags(e))return E(e,"[[error:not-enough-tags, "+P.minTagCount()+"]]");if(d.isActive()&&d.getTimestamp()<=Date.now())return E(e,"[[error:scheduling-to-past]]");let U={uuid:e},ne="post",te="";S==="topics.post"?(te="/topics",U={...U,handle:f?f.val():void 0,title:v.val(),content:T.val(),thumb:y.val()||"",cid:R.getSelectedCid(),tags:P.getTags(e),timestamp:d.getTimestamp()}):S==="posts.reply"?(te=`/topics/${t.tid}`,U={...U,tid:t.tid,handle:f?f.val():void 0,content:T.val(),toPid:t.toPid}):S==="posts.edit"&&(ne="put",te=`/posts/${t.pid}`,U={...U,pid:t.pid,handle:f?f.val():void 0,content:T.val(),title:v.val(),thumb:y.val()||"",tags:P.getTags(e),timestamp:d.getTimestamp()});var ae={composerEl:o,action:S,composerData:U,postData:t,redirect:!0};await a.fire("filter:composer.submit",ae),a.fire("action:composer.submit",Object.freeze(ae));var se=$('#taskbar .composer[data-uuid="'+e+'"] i'),re=o.find(".write");se.removeClass("fa-plus").addClass("fa-circle-o-notch fa-spin"),i.minimize(e),re.prop("readonly",!0),b[ne](te,U).then(Y=>{J.removeAttr("disabled"),t.submitted=!0,i.discard(e),c.removeDraft(t.save_id),Y.queued?D.alert({type:"success",title:"[[global:alert.success]]",message:Y.message,timeout:1e4,clickfn:function(){ajaxify.go(`/post-queue/${Y.id}`)}}):S==="topics.post"?ae.redirect&&ajaxify.go("topic/"+Y.slug,void 0,H||i.bsEnvironment==="xs"||i.bsEnvironment==="sm"):S==="posts.reply"?H||i.bsEnvironment==="xs"||i.bsEnvironment==="sm"?window.history.back():ae.redirect&&(ajaxify.data.template.name!=="topic"||ajaxify.data.template.topic&&parseInt(t.tid,10)!==parseInt(ajaxify.data.tid,10))&&ajaxify.go("post/"+Y.pid):C(),a.fire("action:composer."+S,{composerData:U,data:Y})}).catch(Y=>{if(i.load(e),re.prop("readonly",!1),Y.message==="[[error:email-not-confirmed]]")return m.showEmailConfirmWarning(Y.message);E(e,Y.message)})}function q(){$("html").addClass("composing")}function oe(){$("body").css({paddingBottom:0}),$("html").removeClass("composing"),app.toggleNavbar(!0)}return i.discard=function(e){if(i.posts[e]){var t=i.posts[e],o=$('.composer[data-uuid="'+e+'"]');o.remove(),c.removeDraft(t.save_id),I.deleteAll(e),x.discard("composer",e),$('[data-action="post"]').removeAttr("disabled"),a.fire("action:composer.discard",{post_uuid:e,postData:t}),delete i.posts[e],i.active=void 0}d.reset(),oe()},i.close=i.discard,i.minimize=function(e){var t=$('.composer[data-uuid="'+e+'"]');t.css("visibility","hidden"),i.active=void 0,x.minimize("composer",e),$(window).trigger("action:composer.minimize",{post_uuid:e}),oe()},i.minimizeActive=function(){i.active&&i.miminize(i.active)},i.updateThumbCount=function(e,t){const o=i.posts[e];if(o.action==="topics.post"||o.action==="posts.edit"&&o.isMain){const f=[I.get(e)];o.pid&&f.push(I.getByPid(o.pid)),Promise.all(f).then(v=>{v=v.reduce((T,y)=>(T=T.concat(y),T)),v.length&&t.find('[data-format="thumbs"]').attr("data-count",v.length)})}},i}.apply(V,M),L!==void 0&&(Q.exports=L)},77678:(Q,V,l)=>{var M,L;M=[l(50548),l(27145),l(74344)],L=function(x,w,j){var h={},c;h.init=function(s,n){var d=s.find(".category-list-container");d.length&&(s.on("action:composer.resize",function(){P(s)}),h.updateTaskbar(s,n),c=x.init(d.find('[component="category-selector"]'),{privilege:"topics:create",states:["watching","notwatching","ignoring"],onSelect:function(u){n.hasOwnProperty("cid")&&r(s,n,u)}}),c&&(n.cid&&n.category?c.selectedCategory={cid:n.cid,name:n.category.name}:ajaxify.data.template.compose&&ajaxify.data.selectedCategory&&(c.selectedCategory={cid:ajaxify.data.cid,name:ajaxify.data.selectedCategory}),s.find(".category-name").translateText(c.selectedCategory?c.selectedCategory.name:"[[modules:composer.select_category]]").on("click",function(){x.modal({privilege:"topics:create",states:["watching","notwatching","ignoring"],openOnLoad:!0,showLinks:!1,onSelect:function(u){s.find(".category-name").text(u.name),c.selectCategory(u.cid),n.hasOwnProperty("cid")&&r(s,n,u)}})}),P(s)))};function P(s){s.find('.category-list-container [component="category-selector"]').toggleClass("dropup",s.outerHeight()<$(window).height()/2)}h.getSelectedCid=function(){var s;return c&&(s=c.getSelectedCategory()),s?s.cid:0},h.updateTaskbar=function(s,n){parseInt(n.cid,10)&&j.get(`/categories/${n.cid}`,{}).then(function(d){R(s,d)})};function R(s,n){if(n){var d=s.attr("data-uuid");w.update("composer",d,{image:n.backgroundImage,"background-color":n.bgColor,icon:n.icon&&n.icon.slice(3)})}}async function r(s,n,d){n.cid=d.cid;const u=await window.fetch(`${config.relative_path}/api/category/${d.cid}`).then(I=>I.json());n.category=u,R(s,u),l.e(3913).then(function(){var I=[l(98166),l(88186)];(function(b,A){b.onChangeCategory(u),A.onChangeCategory(s,n,d.cid,u),$(window).trigger("action:composer.changeCategory",{postContainer:s,postData:n,selectedCategory:d,categoryData:u})}).apply(null,I)}).catch(l.oe)}return h}.apply(V,M),L!==void 0&&(Q.exports=L)},73398:(Q,V,l)=>{var M,L;M=[l(59006),l(31369),l(7927)],L=function(x,w,j){const h={},c={timestamp:0,open:!1,edit:!1,posts:{}};let P=[],R;const r={el:null,icon:null,defaultText:"",activeText:""};let s,n;$(window).on("action:composer.activate",b),h.init=function(g,i){c.timestamp=0,c.posts=i,P=g[0].querySelectorAll(".display-scheduler"),R=g[0].querySelectorAll(".display-scheduler i"),r.el=g[0].querySelector(".composer-submit:not(.btn-sm)"),r.icon=r.el.querySelector("i"),r.defaultText=r.el.lastChild.textContent,r.activeText=r.el.getAttribute("data-text-variant"),R.forEach(C=>C.addEventListener("click",d))},h.getTimestamp=function(){return!h.isActive()||isNaN(c.timestamp)?0:c.timestamp},h.isActive=function(){return c.timestamp>0},h.isOpen=function(){return c.open},h.reset=function(){c.timestamp=0},h.onChangeCategory=function(g){p(g.privileges["topics:schedule"]),m(!1),h.reset()};async function d(){const g=await x.render("modals/topic-scheduler");w.dialog({message:g,title:"[[modules:composer.schedule-for]]",className:"topic-scheduler",onShown:u,onHidden:I,onEscape:!0,buttons:{cancel:{label:c.timestamp?"[[modules:composer.cancel-scheduling]]":"[[modules:bootbox.cancel]]",className:(c.timestamp?"btn-warning":"btn-default")+(c.edit?" hidden":""),callback:a},set:{label:"[[modules:composer.set-schedule-date]]",className:"btn-primary",callback:D}}})}function u(g){c.open=!0;const i=g.target.querySelector(".datetime-picker");s=i.querySelector('input[type="date"]'),n=i.querySelector('input[type="time"]'),A()}function I(){c.open=!1}function b(g,{post_uuid:i}){c.edit=!1;const C=c.posts[i];C&&C.isMain&&C.timestamp>Date.now()&&(c.timestamp=C.timestamp,c.edit=!0,m())}function A(){const g=new Date,i=new Date(g.getTime()-g.getTimezoneOffset()*6e4).toJSON();if(s.setAttribute("min",i.slice(0,10)),n.setAttribute("min",i.slice(11,-8)),h.isActive()){const C=new Date(c.timestamp-g.getTimezoneOffset()*6e4).toJSON();s.value=C.slice(0,10),n.value=C.slice(11,-8)}}function D(){const g=s.value&&n.value,i=new Date(`${s.value} ${n.value}`).getTime();if(!g||isNaN(i)||i<Date.now()){c.timestamp=0;const C=i<Date.now()?"[[error:scheduling-to-past]]":"[[error:invalid-schedule-date]]";return j.alert({type:"danger",timeout:3e3,title:"",alert_id:"post_error",message:C}),!1}c.timestamp||m(!0),c.timestamp=i}function a(){c.timestamp&&(m(!1),c.timestamp=0)}function m(g=!0){R.forEach(i=>i.classList.toggle("active",g)),r.icon&&(r.icon.classList.toggle("fa-check",!g),r.icon.classList.toggle("fa-clock-o",g)),r.el.lastChild.textContent=g?r.activeText:r.defaultText}function p(g){P.forEach(i=>i.classList.toggle("hidden",!g))}return h}.apply(V,M),L!==void 0&&(Q.exports=L)},13720:(Q,V,l)=>{var M,L;M=[l(7927)],L=function(x){var w={},j,h;w.init=function(r,s){var n=r.find(".tags");if(n.length){j=ajaxify.data.hasOwnProperty("minTags")?ajaxify.data.minTags:config.minimumTagsPerTopic,h=ajaxify.data.hasOwnProperty("maxTags")?ajaxify.data.maxTags:config.maximumTagsPerTopic,n.tagsinput({confirmKeys:[13,44],trimValue:!0});var d=r.find(".bootstrap-tagsinput input");c(r,s,ajaxify.data),app.loadJQueryUI(function(){d.autocomplete({delay:100,position:{my:"left bottom",at:"left top",collision:"flip"},appendTo:r.find(".bootstrap-tagsinput"),open:function(){$(this).autocomplete("widget").css("z-index",2e4)},source:function(b,A){socket.emit("topics.autocompleteTags",{query:b.term,cid:s.cid},function(D,a){if(D)return x.error(D);a&&A(a),$(".ui-autocomplete a").attr("data-ajaxify","false")})},select:function(){P(d)}}),R(s.tags,n),n.on("beforeItemAdd",function(b){var A=h&&h<=w.getTags(r.attr("data-uuid")).length,D=utils.cleanUpTag(b.item,config.maximumTagLength),a=D!==b.item;if(b.cancel=a||b.item.length<config.minimumTagLength||b.item.length>config.maximumTagLength||A,b.item.length<config.minimumTagLength)return x.error("[[error:tag-too-short, "+config.minimumTagLength+"]]");if(b.item.length>config.maximumTagLength)return x.error("[[error:tag-too-long, "+config.maximumTagLength+"]]");if(A)return x.error("[[error:too-many-tags, "+h+"]]");a&&n.tagsinput("add",D)});var u=!1,I=!1;n.on("itemRemoved",function(b){if(I){I=!1;return}b.item&&socket.emit("topics.canRemoveTag",{tag:b.item},function(A,D){if(A)return x.error(A);D||(x.error("[[error:cant-remove-system-tag]]"),u=!0,n.tagsinput("add",b.item))})}),n.on("itemAdded",function(b){if(u){u=!1;return}var A=s.hasOwnProperty("cid")?s.cid:ajaxify.data.cid;socket.emit("topics.isTagAllowed",{tag:b.item,cid:A||0},function(D,a){if(D)return x.error(D);if(!a)return I=!0,n.tagsinput("remove",b.item);$(window).trigger("action:tag.added",{cid:A,tagEl:n,tag:b.item}),d.length&&d.autocomplete("close")})})}),d.attr("tabIndex",n.attr("tabIndex")),d.on("blur",function(){P(d)}),$('[component="composer/tag/dropdown"]').on("click","li",function(){var u=$(this).attr("data-tag");return u&&R([u],n),!1})}},w.isEnoughTags=function(r){return w.getTags(r).length>=j},w.minTagCount=function(){return j},w.onChangeCategory=function(r,s,n,d){var u=r.find('[component="composer/tag/dropdown"]');u.length&&(c(r,s,d),u.toggleClass("hidden",!d.tagWhitelist||!d.tagWhitelist.length),d.tagWhitelist&&app.parseAndTranslate("composer","tagWhitelist",{tagWhitelist:d.tagWhitelist},function(I){u.find(".dropdown-menu").html(I)}))};function c(r,s,n){var d=r.find(".tags"),u=r.find(".bootstrap-tagsinput input");u.length&&(n.hasOwnProperty("minTags")&&(j=n.minTags),n.hasOwnProperty("maxTags")&&(h=n.maxTags),n.tagWhitelist&&n.tagWhitelist.length?(u.attr("readonly",""),u.attr("placeholder",""),d.tagsinput("items").slice().forEach(function(I){n.tagWhitelist.indexOf(I)===-1&&d.tagsinput("remove",I)})):(u.removeAttr("readonly"),u.attr("placeholder",r.find("input.tags").attr("placeholder"))),r.find(".tags-container").toggleClass("hidden",n.privileges&&n.privileges.hasOwnProperty("topics:tag")&&!n.privileges["topics:tag"]||h===0&&!s&&!s.tags&&!s.tags.length),n.privileges&&n.privileges.hasOwnProperty("topics:tag")&&!n.privileges["topics:tag"]&&d.tagsinput("removeAll"),$(window).trigger("action:tag.toggleInput",{postContainer:r,tagWhitelist:n.tagWhitelist,tagsInput:u}))}function P(r){var s=jQuery.Event("keypress");s.which=13,s.keyCode=13,setTimeout(function(){r.trigger(s)},100)}function R(r,s){if(r&&r.length)for(var n=0;n<r.length;++n)s.tagsinput("add",r[n])}return w.getTags=function(r){return $('.composer[data-uuid="'+r+'"] .tags').tagsinput("items")},w}.apply(V,M),L!==void 0&&(Q.exports=L)},77070:(Q,V,l)=>{var M,L;M=[l(83713),l(98755),l(32230),l(7927),l(33371),l(86569)],L=function(x,w,j,h,c){var P={inProgress:{}},R="";P.initialize=function(a){d(a),u(a),r(a),s(a),j.translate("[[modules:composer.uploading, "+0+"%]]",function(m){R=m})};function r(a){var m=$('.composer[data-uuid="'+a+'"]');m.find("#files").on("change",function(p){var g=(p.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);g&&A({files:g,post_uuid:a,route:"/api/post/upload"})})}function s(a){var m=$('.composer[data-uuid="'+a+'"]');m.on("click",".topic-thumb-clear-btn",function(p){m.find("input#topic-thumb-url").val("").trigger("change"),n(m.find("input#topic-thumb-file")),$(this).addClass("hide"),p.preventDefault()}),m.on("paste change keypress","input#topic-thumb-url",function(){var p=$(this);setTimeout(function(){var g=p.val();g?m.find(".topic-thumb-clear-btn").removeClass("hide"):(n(m.find("input#topic-thumb-file")),m.find(".topic-thumb-clear-btn").addClass("hide")),m.find("img.topic-thumb-preview").attr("src",g)},100)})}function n(a){a.wrap("<form />").closest("form").get(0).reset(),a.unwrap()}function d(a){var m=$('.composer[data-uuid="'+a+'"]');c.handleDragDrop({container:m,callback:function(p){A({files:p.files,post_uuid:a,route:"/api/post/upload",formData:p.formData})}})}function u(a){var m=$('.composer[data-uuid="'+a+'"]');c.handlePaste({container:m,callback:function(p){A({files:p.files,fileNames:p.fileNames,post_uuid:a,route:"/api/post/upload",formData:p.formData})}})}function I(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function b(a,m,p){return a.slice(0,m)+p+a.slice(m)}function A(a){var m=[...a.files],p=a.post_uuid,g=$('.composer[data-uuid="'+p+'"]'),i=g.find("textarea"),C=i.val(),K=g.find("#fileForm"),ie=!1;K.attr("action",config.relative_path+a.route);var X=w.getSelectedCid();!X&&ajaxify.data.cid&&(X=ajaxify.data.cid);var E=0,_=!1;for(E=0;E<m.length;++E)if(_=m[E].type.match(/image./),_&&!app.user.privileges["upload:post:image"]||!_&&!app.user.privileges["upload:post:file"])return h.error("[[error:no-privileges]]");var k=[];for(E=0;E<m.length;++E){if(k.push(E+"_"+Date.now()+"_"+(a.fileNames?a.fileNames[E]:m[E].name)),_=m[E].type.match(/image./),m[E].size>parseInt(config.maximumFileSize,10)*1024)return K[0].reset(),h.error("[[error:file-too-big, "+config.maximumFileSize+"]]");C=b(C,i.getCursorPosition(),(_?"!":"")+"["+k[E]+"]("+R+") ")}K.length&&g.find('[data-action="post"]').prop("disabled",!0),i.val(C),$(window).trigger("action:composer.uploadStart",{post_uuid:p,files:k.map(function(Z,z){return{filename:Z.replace(/^\d+_\d{13}_/,""),isImage:/image./.test(m[z].type)}}),text:R}),K.off("submit").submit(function(){function Z(z,N,O){var G;O&&(G=z.replace(/^\d+_\d{13}_/,""));var ee=i.val(),q=new RegExp(I(z)+"]\\([^)]+\\)","g");i.val(ee.replace(q,(G||z)+"]("+N+")")),$(window).trigger("action:composer.uploadUpdate",{post_uuid:p,filename:z,text:N})}return P.inProgress[p]=P.inProgress[p]||[],P.inProgress[p].push(1),a.formData&&a.formData.append("cid",X),$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:a.formData,data:{cid:X},error:function(z){ie=!0,g.find('[data-action="post"]').prop("disabled",!1);const N=D(z,p);for(var O=0;O<m.length;++O)Z(k[O],N,!0);x.render(g)},uploadProgress:function(z,N,O,G){j.translate("[[modules:composer.uploading, "+G+"%]]",function(ee){if(!ie)for(var q=0;q<m.length;++q)Z(k[q],ee)})},success:function(z){const N=z.response.images;if(ie=!0,N&&N.length)for(var O=0;O<N.length;++O)N[O].filename=k[O].replace(/^\d+_\d{13}_/,""),N[O].isImage=/image./.test(m[O].type),Z(k[O],N[O].url,!0);x.render(g),i.focus(),g.find('[data-action="post"]').prop("disabled",!1),$(window).trigger("action:composer.upload",{post_uuid:p,files:N})},complete:function(){K[0].reset(),P.inProgress[p].pop()}}),!1}),K.submit()}function D(a,m){var p=a.responseJSON&&(a.responseJSON.error||a.responseJSON.status&&a.responseJSON.status.message)||"[[error:parse-error]]";return a&&a.status===413&&(p=a.statusText||"Request Entity Too Large"),h.error(p),$(window).trigger("action:composer.uploadError",{post_uuid:m,message:p}),p}return P}.apply(V,M),L!==void 0&&(Q.exports=L)}}]);
